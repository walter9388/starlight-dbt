---
import { Icon } from '@astrojs/starlight/components';
import type { ComponentProps } from 'astro/types';
import { CustomIcon } from 'starlight-dbt/components';
import { type StarlightIcon as CustomStarlightIcon, Icons as CustomIconsObj } from './Icons';

interface Props {
	isFile?: boolean;
	isRoot?: boolean;
	depth: number;
	types: string[];
}

const { isFile, isRoot, depth, types } = Astro.props;

const isDatabase = types.includes('database');
const isProject = types.includes('project');
const isGroup = types.includes('group');

type IconName = ComponentProps<typeof Icon>['name'];
let iconName: IconName | CustomStarlightIcon | undefined;
let openIconName: IconName | CustomStarlightIcon | undefined;
if (isRoot) iconName = 'setting';

if (depth > 0) {
	if (isFile) {
		iconName = 'document';
	} else if (isDatabase) {
		// Database logic: Depth 1 = DB, Depth 2 = Schema
		iconName = depth === 1 ? 'database' : 'schema';
	} else if (isProject) {
		iconName = 'folder';
		openIconName = 'folder-open';
	} else if (isGroup) {
		iconName = 'group';
	}
}

function isCustomIcon(name: string | undefined): name is CustomStarlightIcon {
	return !!name && name in CustomIconsObj;
}
---

<span class="icon-wrapper">
	{
		iconName &&
			(isCustomIcon(iconName) ? (
				<CustomIcon name={iconName} size="1rem" class="dbt-sidebar-icon default-icon" />
			) : (
				<Icon name={iconName as any} size="1rem" class="dbt-sidebar-icon default-icon" />
			))
	}

	{
		openIconName &&
			(isCustomIcon(openIconName) ? (
				<CustomIcon name={openIconName} size="1rem" class="dbt-sidebar-icon open-icon" />
			) : (
				<Icon name={openIconName as any} size="1rem" class="dbt-sidebar-icon open-icon" />
			))
	}
</span>

<style>
	.icon-wrapper {
		/* This makes the span act like it doesn't exist for layout purposes, 
           letting the icons sit inline with the text. */
		display: contents;
	}

	.dbt-sidebar-icon {
		flex-shrink: 0;
		margin-inline-end: 0.5rem; /* Re-adding spacing between icon and text */
		color: var(--sl-color-gray-3);
		vertical-align: middle;
	}

	/* ... keep the rest of your toggle and color logic below ... */
	.open-icon {
		display: none !important;
	}

	:global(details[open] > summary) .open-icon,
	:global(details:has(a[aria-current='page']) > summary) .open-icon {
		display: inline-block !important;
	}

	:global(details[open] > summary) .default-icon,
	:global(details:has(a[aria-current='page']) > summary) .default-icon {
		display: none !important;
	}

	/* Active colors */
	:global(a[aria-current='page']) .dbt-sidebar-icon {
		color: var(--sl-color-text-invert) !important;
	}

	:global(.dbt-root-node details:has(a[aria-current='page']) > summary) .dbt-sidebar-icon {
		color: var(--sl-color-accent-high) !important;
	}
</style>
