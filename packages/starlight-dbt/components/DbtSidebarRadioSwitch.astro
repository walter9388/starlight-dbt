---
interface Props {
	projectId: string;
}
const { projectId } = Astro.props;
const safeId = projectId.replace(/[^a-z0-9]/gi, '-').toLowerCase();
const storageKey = `dbt-view-pref-${safeId}`;
---

<div class="dbt-switcher" data-project-id={safeId}>
	<input
		type="radio"
		name={`dbt-view-${safeId}`}
		id={`v-project-${safeId}`}
		value="project"
		checked
	/>
	<label for={`v-project-${safeId}`}>Project</label>

	<input type="radio" name={`dbt-view-${safeId}`} id={`v-database-${safeId}`} value="database" />
	<label for={`v-database-${safeId}`}>Database</label>

	<input type="radio" name={`dbt-view-${safeId}`} id={`v-group-${safeId}`} value="group" />
	<label for={`v-group-${safeId}`}>Group</label>
</div>

<script is:inline define:vars={{ safeId, storageKey }}>
	// @ts-nocheck
	(() => {
		const saved = localStorage.getItem(storageKey);
		if (saved) {
			const input = document.querySelector(`#v-${saved}-${safeId}`);
			if (input) input.checked = true;
		}
	})();
</script>

<script>
	// Logic for expanding folders remains global but reacts to local changes
	const syncSidebarExpansion = () => {
		// Find the currently active link that is visible in the current view
		// We look for aria-current="page"
		const activeLinks = Array.from(
			document.querySelectorAll('.dbt-root-node a[aria-current="page"]')
		) as HTMLElement[];

		activeLinks.forEach((link) => {
			// Walk up the DOM tree from the link
			let parent = link.parentElement;
			while (parent && !parent.classList.contains('dbt-root-node')) {
				// If we hit a <details> element, open it
				if (parent instanceof HTMLDetailsElement) parent.open = true;
				parent = parent.parentElement;
			}
		});

		// Scroll the sidebar to the active link if it's off-screen
		const visibleActive = Array.from(activeLinks).find((el) => el.offsetParent !== null);
		if (visibleActive) {
			visibleActive.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
		}
	};

	// Trigger expansion when the radio buttons change
	document.addEventListener('change', (e) => {
		const target = e.target as HTMLInputElement;
		// Check if the change came from one of our dbt switchers
		const switcher = target.closest('.dbt-switcher');
		if (switcher instanceof HTMLElement) {
			const projectId = switcher.dataset.projectId;
			const storageKey = `dbt-view-pref-${projectId}`;
			localStorage.setItem(storageKey, target.value);

			// Allow a tiny delay for CSS 'display: block' to kick in
			setTimeout(syncSidebarExpansion, 10);
		}
	});

	// Also trigger on initial page load (for the is:inline persistence)
	window.addEventListener('load', syncSidebarExpansion);
</script>

<style>
	.dbt-switcher {
		display: flex;
		background: var(--sl-color-gray-6);
		border-radius: 0.4rem;
		padding: 0.2rem;
		margin: 0.5rem var(--sl-sidebar-item-padding-inline);
		gap: 0.2rem;
		border: 1px solid var(--sl-color-hairline);
	}

	.dbt-switcher input {
		display: none;
	}

	.dbt-switcher label {
		flex: 1;
		text-align: center;
		font-size: 0.7rem;
		padding: 0.25rem;
		cursor: pointer;
		border-radius: 0.25rem;
		color: var(--sl-color-gray-3);
		text-transform: uppercase;
		letter-spacing: 0.05em;
		transition:
			background 0.2s,
			color 0.2s;
	}

	.dbt-switcher input:checked + label {
		background: var(--sl-color-accent-low);
		color: var(--sl-color-white);
		font-weight: 600;
	}
</style>
