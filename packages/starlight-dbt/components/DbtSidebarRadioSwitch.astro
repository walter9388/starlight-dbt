---
import { CustomIcon } from 'starlight-dbt/components';
import { type StarlightIcon as CustomStarlightIcon } from './Icons';

interface Props {
	projectId: string;
}
const { projectId } = Astro.props;
const safeId = projectId.replace(/[^a-z0-9]/gi, '-').toLowerCase();
const storageKey = `dbt-view-pref-${safeId}`;

const options: { value: string; label: string; icon: CustomStarlightIcon }[] = [
	{ value: 'project', label: 'Project', icon: 'folder' },
	{ value: 'database', label: 'Database', icon: 'database' },
	{ value: 'group', label: 'Group', icon: 'group' },
];
---

<div class="dbt-switcher" data-project-id={safeId}>
	{
		options.map((opt) => (
			<>
				<input
					type="radio"
					name={`dbt-view-${safeId}`}
					id={`v-${opt.value}-${safeId}`}
					value={opt.value}
					checked={opt.value === 'project'}
				/>
				<label for={`v-${opt.value}-${safeId}`} title={opt.label}>
					<CustomIcon name={opt.icon} size="1rem" />
					<span class="label-text">{opt.label}</span>
				</label>
			</>
		))
	}
</div>

<script is:inline define:vars={{ safeId, storageKey }}>
	// @ts-nocheck
	(() => {
		const saved = localStorage.getItem(storageKey);
		if (saved) {
			const input = document.querySelector(`#v-${saved}-${safeId}`);
			if (input) input.checked = true;
		}
	})();
</script>

<script>
	// Logic for expanding folders remains global but reacts to local changes
	const syncSidebarExpansion = () => {
		// Find the currently active link that is visible in the current view
		// We look for aria-current="page"
		const activeLinks = Array.from(
			document.querySelectorAll('.dbt-root-node a[aria-current="page"]')
		) as HTMLElement[];

		activeLinks.forEach((link) => {
			// Walk up the DOM tree from the link
			let parent = link.parentElement;
			while (parent && !parent.classList.contains('dbt-root-node')) {
				// If we hit a <details> element, open it
				if (parent instanceof HTMLDetailsElement) parent.open = true;
				parent = parent.parentElement;
			}
		});

		// Scroll the sidebar to the active link if it's off-screen
		const visibleActive = Array.from(activeLinks).find((el) => el.offsetParent !== null);
		if (visibleActive) {
			visibleActive.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
		}
	};

	// Trigger expansion when the radio buttons change
	document.addEventListener('change', (e) => {
		const target = e.target as HTMLInputElement;
		// Check if the change came from one of our dbt switchers
		const switcher = target.closest('.dbt-switcher');
		if (switcher instanceof HTMLElement) {
			const projectId = switcher.dataset.projectId;
			const storageKey = `dbt-view-pref-${projectId}`;
			localStorage.setItem(storageKey, target.value);

			// Allow a tiny delay for CSS 'display: block' to kick in
			setTimeout(syncSidebarExpansion, 10);
		}
	});

	// Also trigger on initial page load (for the is:inline persistence)
	window.addEventListener('load', syncSidebarExpansion);
</script>

<style>
	.dbt-switcher {
		display: flex;
		background: var(--sl-color-gray-6);
		border-radius: 0.4rem;
		padding: 0.2rem;
		margin: 0.5rem var(--sl-sidebar-item-padding-inline);
		gap: 0.2rem;
		border: 1px solid var(--sl-color-hairline);
	}

	.dbt-switcher input {
		display: none;
	}

	.dbt-switcher label {
		flex: 1;
		display: flex;
		flex-direction: row;
		align-items: center;
		justify-content: center;
		gap: 0.3rem;
		min-width: 0;
		font-size: 0.65rem;
		padding: 0.4rem 0.2rem;
		cursor: pointer;
		border-radius: 0.25rem;
		color: var(--sl-color-gray-3);
		text-transform: uppercase;
		transition: all 0.2s;
	}

	.dbt-switcher label :global(svg) {
		flex-shrink: 0;
	}

	/* --- Side-by-Side (Default / Wide) --- */
	.dbt-switcher label {
		flex-direction: row;
		gap: 0.4rem;
		font-size: 0.7rem;
	}
	/* --- Stacked (Medium Width) --- */
	@container (max-width: 260px) {
		.dbt-switcher label {
			flex-direction: column;
			gap: 0.1rem;
			font-size: 0.6rem;
			padding: 0.4rem 0.1rem;
		}
		.label-text {
			text-transform: uppercase;
			letter-spacing: 0.02em;
		}
	}
	/* --- Icon Only (Narrow) --- */
	@container (max-width: 180px) {
		.label-text {
			display: none;
		}
		.dbt-switcher label {
			padding: 0.5rem 0;
		}
		.switcher-icon {
			transform: scale(1.1);
		}
	}

	/* Fallback: Hide text when sidebar is very narrow */
	.dbt-switcher {
		container-type: inline-size;
	}

	.dbt-switcher input:checked + label {
		background: var(--sl-color-accent-low);
		color: var(--sl-color-white);
		font-weight: 600;
	}

	.label-text {
		white-space: nowrap;
		overflow: hidden;
		text-overflow: ellipsis;
	}
</style>
